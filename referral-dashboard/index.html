<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Referral Dashboard - JL Solutions</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css">
  <link rel="icon" href="/assets/images/jlsolutions-logo.png" type="image/png">
  <style>
    :root { --primary: #0078D4; --bg: #121212; --card: #1a1a1a; }
    body { font-family: 'Inter', sans-serif; background: var(--bg); color: #e0e0e0; }
    .dashboard-header { background: linear-gradient(135deg, var(--primary) 0%, #004298 100%); padding: 2rem 0; color: white; }
    .stat-card { background: var(--card); border-radius: 12px; padding: 1.5rem; border: 1px solid rgba(255,255,255,0.1); }
    .stat-value { font-size: 2rem; font-weight: 700; color: var(--primary); }
    .code-badge { background: rgba(0,120,212,0.2); padding: 0.5rem 1rem; border-radius: 8px; font-family: monospace; font-weight: 600; }
    .referrals-table { background: var(--card); border-radius: 12px; overflow: hidden; }
    .referrals-table th, .referrals-table td { padding: 1rem; border-color: rgba(255,255,255,0.1); }
    .btn-logout { background: transparent; border: 1px solid rgba(255,255,255,0.3); color: white; }
    .btn-logout:hover { background: rgba(255,255,255,0.1); color: white; }
  </style>
</head>
<body>
  <nav class="navbar navbar-dark bg-dark">
    <div class="container">
      <a class="navbar-brand" href="/">JL Solutions</a>
      <span class="text-white-50 me-3" id="userEmail"></span>
      <button class="btn btn-logout btn-sm" onclick="referralSignOut()">Sign Out</button>
    </div>
  </nav>

  <div class="dashboard-header">
    <div class="container">
      <h1 class="mb-1">Referral Dashboard</h1>
      <p class="mb-0 opacity-75">Track your referrals and commissions</p>
    </div>
  </div>

  <div class="container my-4">
    <div id="loading" class="text-center py-5">Loading...</div>
    <div id="content" style="display:none;">
      <div class="row g-4 mb-4">
        <div class="col-md-4">
          <div class="stat-card">
            <small class="text-muted">Total Referrals</small>
            <div class="stat-value" id="totalReferrals">0</div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="stat-card">
            <small class="text-muted">Pending Earnings</small>
            <div class="stat-value" id="pendingEarnings">$0.00</div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="stat-card">
            <small class="text-muted">Total Earnings</small>
            <div class="stat-value" id="totalEarnings">$0.00</div>
          </div>
        </div>
      </div>

      <div class="mb-4">
        <h4 class="mb-3">Your Referral Code(s)</h4>
        <div id="codesList" class="d-flex flex-wrap gap-2 mb-3"></div>
        <button class="btn btn-primary" id="createCodeBtn" style="display:none;">Generate New Code</button>
      </div>

      <div>
        <h4 class="mb-3">Referrals</h4>
        <div class="referrals-table">
          <table class="table table-dark table-hover mb-0">
            <thead>
              <tr>
                <th>Date</th>
                <th>Referred Email</th>
                <th>Amount</th>
                <th>Commission</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="referralsTable">
              <tr><td colspan="5" class="text-center text-muted py-4">No referrals yet. Share your code to get started.</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>window.JL_SUPABASE = { url: 'SUPABASE_URL_PLACEHOLDER', anonKey: 'SUPABASE_ANON_KEY_PLACEHOLDER' };</script>
  <script src="/js/supabase-client.js"></script>
  <script src="/js/referral-auth.js"></script>
  <script>
    (async function() {
      const user = await requireReferralAuth();
      if (!user) return;
      document.getElementById('userEmail').textContent = user.email;

      const loading = document.getElementById('loading');
      const content = document.getElementById('content');

      try {
        const data = await referralApi('stats');
        loading.style.display = 'none';
        content.style.display = 'block';

        document.getElementById('totalReferrals').textContent = data.totalReferrals || 0;
        document.getElementById('pendingEarnings').textContent = '$' + ((data.pendingEarnings || 0) / 100).toFixed(2);
        document.getElementById('totalEarnings').textContent = '$' + ((data.totalEarnings || 0) / 100).toFixed(2);

        const codesList = document.getElementById('codesList');
        const codes = data.codes || [];
        codes.forEach(c => {
          const span = document.createElement('span');
          span.className = 'code-badge';
          span.textContent = c.code;
          span.title = 'Commission: ' + (c.commission_rate || 10) + '%';
          codesList.appendChild(span);
        });

        const createCodeBtn = document.getElementById('createCodeBtn');
        const hasSalesCode = codes.some(c => c.type === 'sales_agent' || c.commission_rate > 0);
        if (!hasSalesCode || codes.length === 0) createCodeBtn.style.display = 'inline-block';

        createCodeBtn.onclick = async () => {
          createCodeBtn.disabled = true;
          try {
            const res = await referralApi('create-code', {
              method: 'POST',
              body: JSON.stringify({ commissionRate: 10 }),
            });
            if (res.code) location.reload();
          } catch (e) {
            alert(e.message || 'Failed to create code');
          }
          createCodeBtn.disabled = false;
        };

        const tbody = document.getElementById('referralsTable');
        const referrals = data.referrals || [];
        if (referrals.length > 0) {
          tbody.innerHTML = referrals.map(r => `
            <tr>
              <td>${new Date(r.created_at).toLocaleDateString()}</td>
              <td>${r.referred_email || '-'}</td>
              <td>$${((r.amount_cents || 0) / 100).toFixed(2)}</td>
              <td>$${((r.commission_cents || 0) / 100).toFixed(2)}</td>
              <td><span class="badge bg-${r.status === 'paid' ? 'success' : 'warning'}">${r.status}</span></td>
            </tr>
          `).join('');
        }
      } catch (e) {
        loading.innerHTML = '<p class="text-danger">' + (e.message || 'Failed to load data') + '</p>';
      }
    })();
  </script>
</body>
</html>
